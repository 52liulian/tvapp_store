name: Build and Deploy TV App Store

on:
  push:
    branches: [ main ]
    paths:
      - 'app/**/*'          # ç›‘å¬appç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶å˜æ›´
      - '!app/**/*.md'      # æ’é™¤è‡ªåŠ¨ç”Ÿæˆçš„.mdæ–‡ä»¶
      - 'update_readme.py'   # ç›‘å¬è„šæœ¬å˜æ›´
      - 'css/**/*'           # ç›‘å¬CSSæ–‡ä»¶å˜æ›´
      - 'help/**/*'          # ç›‘å¬å¸®åŠ©é¡µé¢æ–‡ä»¶å˜æ›´
      - 'images/**/*'        # ç›‘å¬å›¾ç‰‡æ–‡ä»¶å˜æ›´
      - 'js/**/*.js'         # ç›‘å¬JSæ–‡ä»¶å˜æ›´
      - '!js/app_data.js'    # æ’é™¤è‡ªåŠ¨ç”Ÿæˆçš„app_data.jsæ–‡ä»¶
      - '!js/app_data.json'  # æ’é™¤è‡ªåŠ¨ç”Ÿæˆçš„app_data.jsonæ–‡ä»¶
      - 'index.html'         # ç›‘å¬HTMLæ–‡ä»¶å˜æ›´
      - '.github/workflows/**/*'  # ç›‘å¬å·¥ä½œæµæ–‡ä»¶å˜æ›´

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # è¿™é‡Œå¯ä»¥æ·»åŠ ä»»ä½•éœ€è¦çš„ä¾èµ–
        
    - name: Check if app directory exists
      id: check_app_dir
      run: |
        if [ -d "app" ]; then
          echo "app_directory_exists=true" >> $GITHUB_OUTPUT
          echo "âœ“ appç›®å½•å­˜åœ¨ï¼Œç»§ç»­æ‰§è¡Œ"          
          # åˆ—å‡ºappç›®å½•å†…å®¹ï¼Œç”¨äºè°ƒè¯•
          ls -la app/
        else
          echo "app_directory_exists=false" >> $GITHUB_OUTPUT
          echo "âœ— appç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡åç»­æ­¥éª¤"
        fi

    - name: Generate app data
      if: steps.check_app_dir.outputs.app_directory_exists == 'true'
      run: |
        # è¿è¡Œè„šæœ¬ç”Ÿæˆåº”ç”¨æ•°æ®
        python update_readme.py
        echo "åº”ç”¨æ•°æ®ç”Ÿæˆå®Œæˆ"
        
    - name: Verify generated files
      if: steps.check_app_dir.outputs.app_directory_exists == 'true'
      run: |
        # éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f js/app_data.js ]; then
          echo "âœ“ app_data.js ç”ŸæˆæˆåŠŸ"
        else
          echo "âœ— app_data.js ç”Ÿæˆå¤±è´¥" && exit 1
        fi
        
        # éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶å†…å®¹æ˜¯å¦æœ‰æ•ˆ
        grep -q "const appData" js/app_data.js && echo "âœ“ app_data.js å†…å®¹æœ‰æ•ˆ" || echo "âœ— app_data.js å†…å®¹æ— æ•ˆ"
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./       # å‘å¸ƒæ•´ä¸ªç›®å½•
        publish_branch: gh-pages
        force_orphan: true
        keep_files: true      # ä¿ç•™å·²æœ‰æ–‡ä»¶
        
    - name: Clean up
      run: |
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f *.pyc
        rm -rf __pycache__
        
    - name: Notify
      run: |
        echo "ğŸ‰ TV App Store å·²æˆåŠŸæ›´æ–°ï¼"
        echo "ğŸ“¦ åº”ç”¨æ•°æ®å·²é‡æ–°ç”Ÿæˆ"
        echo "ğŸš€ å·²éƒ¨ç½²åˆ° GitHub Pages"
        echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)"